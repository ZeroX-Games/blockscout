name: Docker compose CI

on:
  push:
    branches: [ "prod", "test" ]

jobs:
  compose:
    name: docker compose ci
    runs-on: self-hosted
    steps:
    - name: Attempt to modify shared db files permissions (if exists)
      working-directory: ./docker-compose/services
      run: echo ${{ secrets.SHUSERPWD }} | sudo -S chmod -R 777 ./blockscout-db-data ./stats-db-data
      continue-on-error: true
    - name: Spin down docker and clean up volumes
      working-directory: ./docker-compose
      run: docker compose -f ./custom-backend.yml down -v
    - uses: actions/checkout@v4
      with:
        clean: false
    - name: Compose docker for custom backend
      working-directory: ./docker-compose
      run: docker compose -f ./custom-backend.yml up -d --build --force-recreate
