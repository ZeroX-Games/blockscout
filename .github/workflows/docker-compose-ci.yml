name: Docker compose CI

on:
  push:
    branches: [ "prod", "test" ]

jobs:
  compose:
    name: docker compose ci
    runs-on: self-hosted
    steps:
    - name: Attempt to modify shared db files permissions (if exists)
      run: chmod -R 777 ./services/blockscout-db-data ./services/stats-db-data
      continue-on-error: true
    - name: (PROD only) Spin down docker and clean up volumes
      if: github.ref == 'refs/heads/prod'
      working-directory: ./docker-compose
      run: docker compose -f ./custom-backend.yml down -v
    - uses: actions/checkout@v4
      with:
        clean: false
    - name: Compose docker for custom backend
      working-directory: ./docker-compose
      run: docker compose -f ./custom-backend.yml up -d --build --force-recreate
